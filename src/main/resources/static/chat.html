<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
          font-family: Arial, sans-serif;
          background: #f0f2f5;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
        }
        #chat-container {
          width: 420px;
          height: 600px;
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }
        #chat-header {
          background: #0084ff;
          color: white;
          padding: 12px;
          text-align: center;
          font-weight: bold;
        }
        #messages {
          flex: 1;
          padding: 12px;
          overflow-y: auto;
          display: flex;
          flex-direction: column;
        }
        .message {
          margin: 6px 0;
          padding: 10px 14px;
          border-radius: 20px;
          max-width: 70%;
          word-wrap: break-word;
        }
        .message.self {
          align-self: flex-end;
          background: #0084ff;
          color: white;
        }
        .message.other {
          align-self: flex-start;
          background: #e4e6eb;
          color: black;
        }
        #input-area {
          display: flex;
          padding: 10px;
          background: #f0f2f5;
        }
        #input-area input {
          flex: 1;
          padding: 10px;
          border-radius: 20px;
          border: 1px solid #ccc;
          outline: none;
        }
        #input-area button {
          margin-left: 8px;
          padding: 10px 16px;
          border: none;
          border-radius: 20px;
          background: #0084ff;
          color: white;
          cursor: pointer;
        }
        #connect-form {
          padding: 10px;
          background: #fafafa;
          border-bottom: 1px solid #ddd;
        }
        #connect-form input {
          margin: 5px 0;
          padding: 6px;
          width: calc(100% - 12px);
        }
        #connect-form button {
          margin-top: 8px;
          width: 100%;
          padding: 8px;
          border: none;
          border-radius: 6px;
          background: #42b72a;
          color: white;
          font-weight: bold;
          cursor: pointer;
        }
    </style>
</head>
<body>
<div id="chat-container">
    <div id="connect-form">
        <input type="text" id="token" placeholder="Enter JWT token" />
        <input type="text" id="senderId" placeholder="Enter your User ID" />
        <input type="text" id="receiverId" placeholder="Enter Receiver User ID" />
        <button onclick="connect()">Connect</button>
    </div>
    <div id="chat-header">Not connected</div>
    <div id="messages"></div>
    <div id="input-area">
        <input type="text" id="message" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    let stompClient = null;
    let token = null;
    let senderId = null;
    let receiverId = null;

    function connect() {
      token = document.getElementById("token").value;
      senderId = document.getElementById("senderId").value;
      receiverId = document.getElementById("receiverId").value;

      if (!token || !senderId || !receiverId) {
        alert("Please fill all fields!");
        return;
      }

      const socket = new SockJS("/ws");
      stompClient = Stomp.over(socket);

      stompClient.connect(
        { Authorization: "Bearer " + token },
        (frame) => {
          console.log("Connected: " + frame);

          // Fetch receiver username để hiển thị header
          fetch("/users/" + receiverId, {
            headers: { "Authorization": "Bearer " + token }
          })
          .then(res => res.json())
          .then(data => {
            document.getElementById("chat-header").innerText = "Chat with: " + data.username;
          })
          .catch(() => {
            document.getElementById("chat-header").innerText = "Chat with: " + receiverId;
          });

          // Subscribe vào queue riêng
          stompClient.subscribe("/user/queue/messages", (message) => {
            showMessage(JSON.parse(message.body), false);
          });
        },
        (error) => {
          alert("Connection error: " + error);
        }
      );
    }

    function sendMessage() {
      const content = document.getElementById("message").value;
      if (content && stompClient) {
        const msg = {
          content: content,
          receiverId: receiverId
        };
        stompClient.send("/app/chat.sendMessage", { Authorization: "Bearer " + token }, JSON.stringify(msg));
        showMessage({ content: content }, true);
        document.getElementById("message").value = "";
      }
    }

    function showMessage(message, self) {
      const messagesDiv = document.getElementById("messages");
      const msgEl = document.createElement("div");
      msgEl.className = "message " + (self ? "self" : "other");
      msgEl.textContent = message.content;
      messagesDiv.appendChild(msgEl);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>
